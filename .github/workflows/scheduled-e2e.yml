# Scheduled E2E Tests - Automated Health Checks
#
# This workflow runs E2E tests on a schedule (twice daily) to detect regressions
# and ensure the application remains stable over time.
#
# Schedule:
# - 6:00 AM WIB (23:00 UTC previous day)
# - 6:00 PM WIB (11:00 AM UTC)
#
# Why Scheduled E2E?
# - Faster PR workflow (E2E removed from PR checks)
# - Regular health monitoring of main branch
# - Early detection of regressions without blocking PRs
# - Cost-effective CI minutes usage
#
# Trade-offs:
# - Bugs may reach main before E2E detects them
# - E2E failures discovered after merge (not before)
# - Requires monitoring and quick response to failures

name: Scheduled E2E Tests

on:
  schedule:
    # 6:00 AM WIB = 23:00 UTC (previous day)
    - cron: '0 23 * * *'
    # 6:00 PM WIB = 11:00 AM UTC
    - cron: '0 11 * * *'
  
  # Allow manual trigger for testing
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '21'

jobs:
  e2e-tests:
    name: E2E Tests (Scheduled)
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: registrationform_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Backend Setup ---
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build backend (skip tests)
        working-directory: backend/ikp-labs-api
        run: mvn package -DskipTests -B

      - name: Start Spring Boot backend
        working-directory: backend/ikp-labs-api
        run: |
          nohup java -jar target/*.jar \
            --spring.datasource.url=jdbc:postgresql://localhost:5432/registrationform_db \
            --spring.datasource.username=postgres \
            --spring.datasource.password=postgres \
            --spring.jpa.hibernate.ddl-auto=update \
            > /tmp/spring-boot.log 2>&1 &

      - name: Wait for backend health check
        run: |
          echo "Waiting for backend to start..."
          for i in $(seq 1 30); do
            if curl -s http://localhost:8081/api/auth/health | grep -q "UP"; then
              echo "✅ Backend is healthy!"
              break
            fi
            echo "Attempt $i/30 - waiting 5s..."
            sleep 5
          done
          if ! curl -s http://localhost:8081/api/auth/health | grep -q "UP"; then
            echo "❌ Backend failed to start within 150s"
            echo "=== Spring Boot Log (last 50 lines) ==="
            tail -50 /tmp/spring-boot.log || true
            exit 1
          fi

      # --- Frontend Setup ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install native binaries for Linux
        run: |
          cd frontend
          npm install @next/swc-linux-x64-gnu @next/swc-linux-x64-musl \
            @unrs/resolver-binding-linux-x64-gnu \
            lightningcss-linux-x64-gnu \
            @tailwindcss/oxide-linux-x64-gnu \
            --no-save --force || true

      - name: Build frontend
        run: npm run build:frontend

      - name: Start frontend
        run: |
          cd frontend
          nohup npx next start -p 3002 > /tmp/nextjs.log 2>&1 &

      - name: Wait for frontend health check
        run: |
          echo "Waiting for frontend to start..."
          for i in $(seq 1 15); do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:3002/ | grep -q "200"; then
              echo "✅ Frontend is healthy!"
              break
            fi
            echo "Attempt $i/15 - waiting 3s..."
            sleep 3
          done
          if ! curl -s -o /dev/null -w "%{http_code}" http://localhost:3002/ | grep -q "200"; then
            echo "❌ Frontend failed to start within 45s"
            echo "=== Next.js Log ==="
            cat /tmp/nextjs.log || true
            exit 1
          fi

      # --- Playwright E2E Tests ---
      - name: Get Playwright version
        id: playwright-version
        run: echo "PLAYWRIGHT_VERSION=$(npx playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.PLAYWRIGHT_VERSION }}

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Verify full stack status
        run: |
          echo "=== Backend ==="
          curl -s http://localhost:8081/api/auth/health | head -1
          echo ""
          echo "=== Frontend ==="
          curl -s -o /dev/null -w "HTTP %{http_code}" http://localhost:3002/
          echo ""
          echo "=== PostgreSQL ==="
          pg_isready -h localhost -p 5432 && echo "PostgreSQL is ready" || echo "PostgreSQL not ready"

      - name: Run E2E tests
        env:
          CI: true
        run: npx playwright test --project=chromium

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results-${{ github.run_number }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ github.run_number }}
          path: playwright-report/
          retention-days: 7
