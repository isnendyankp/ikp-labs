# CI Workflow - Automated Testing and Quality Checks
#
# This workflow runs on every push and pull request to ensure code quality.
# It performs:
# - Frontend linting (ESLint + Prettier)
# - Frontend unit tests (Jest) with coverage
# - Frontend build (TypeScript check + Next.js build)
# - Backend tests (JUnit) with JaCoCo coverage
# - API tests (Playwright against running backend + PostgreSQL)
#
# Note: E2E tests moved to scheduled workflow (6 AM & 6 PM WIB)
# See: .github/workflows/scheduled-e2e.yml
#
# Workflow Structure:
# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ                     Push / PR Trigger                           ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#                              ‚îÇ
#       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
#       ‚îÇ              ‚îÇ       ‚îÇ              ‚îÇ               ‚îÇ
#       ‚ñº              ‚ñº       ‚ñº              ‚ñº               ‚ñº
# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ Frontend ‚îÇ  ‚îÇ Frontend ‚îÇ ‚îÇ Backend  ‚îÇ ‚îÇ   API    ‚îÇ ‚îÇ Frontend ‚îÇ
# ‚îÇ   Lint   ‚îÇ  ‚îÇ  Tests   ‚îÇ ‚îÇ  Tests   ‚îÇ ‚îÇ  Tests   ‚îÇ ‚îÇ  Build   ‚îÇ
# ‚îÇ(ESLint + ‚îÇ  ‚îÇ (Jest +  ‚îÇ ‚îÇ(JUnit +  ‚îÇ ‚îÇ(Playwright‚îÇ ‚îÇ(TypeScript
# ‚îÇ Prettier)‚îÇ  ‚îÇ Coverage)‚îÇ ‚îÇ JaCoCo)  ‚îÇ ‚îÇ+Postgres)‚îÇ ‚îÇ  +Next.js)
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#       ‚îÇ              ‚îÇ            ‚îÇ             ‚îÇ             ‚îÇ
#       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#                                   ‚îÇ
#                                   ‚ñº
#                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
#                            ‚îÇ  CI Summary  ‚îÇ
#                            ‚îÇ  All Pass=‚úÖ  ‚îÇ
#                            ‚îÇ  Any Fail=‚ùå  ‚îÇ
#                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#
# Duration: ~3 minutes (faster without E2E)
#

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '21'

jobs:
  # ===========================================
  # Frontend Lint (ESLint + Prettier)
  # ===========================================
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install native binaries for Linux
        run: |
          cd frontend
          npm install @next/swc-linux-x64-gnu @next/swc-linux-x64-musl \
            @unrs/resolver-binding-linux-x64-gnu \
            lightningcss-linux-x64-gnu \
            @tailwindcss/oxide-linux-x64-gnu \
            --no-save --force || true

      - name: Run ESLint
        working-directory: frontend
        run: npm run lint:check

      - name: Check Prettier formatting
        working-directory: frontend
        run: npm run format:check

  # ===========================================
  # Frontend Unit Tests (Jest + Coverage)
  # ===========================================
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install native binaries for Linux
        run: |
          cd frontend
          npm install @next/swc-linux-x64-gnu @next/swc-linux-x64-musl \
            @unrs/resolver-binding-linux-x64-gnu \
            lightningcss-linux-x64-gnu \
            @tailwindcss/oxide-linux-x64-gnu \
            --no-save --force || true

      - name: Run frontend unit tests
        working-directory: frontend
        run: npx jest --watchAll=false --coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage
          path: |
            coverage/
            frontend/coverage/
          retention-days: 7
          if-no-files-found: warn

      - name: Coverage Summary
        run: |
          echo "## Frontend Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/lcov.info ] || [ -f frontend/coverage/lcov.info ]; then
            echo "‚úÖ Jest coverage report generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìä Coverage report uploaded as artifact" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ Tests completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìä Check the uploaded artifact for detailed coverage" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================
  # Frontend Build (TypeScript + Next.js)
  # ===========================================
  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: [frontend-lint, frontend-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install native binaries for Linux
        run: |
          cd frontend
          npm install @next/swc-linux-x64-gnu @next/swc-linux-x64-musl \
            @unrs/resolver-binding-linux-x64-gnu \
            lightningcss-linux-x64-gnu \
            @tailwindcss/oxide-linux-x64-gnu \
            --no-save --force || true

      - name: Build frontend
        run: npm run build:frontend

  # ===========================================
  # Backend Tests (JUnit + JaCoCo Coverage)
  # Note: Tests use H2 in-memory database (configured in application-test.properties)
  # PostgreSQL service not needed for unit tests
  # ===========================================
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run backend tests with coverage
        working-directory: backend/ikp-labs-api
        # Tests use H2 in-memory database (configured in application-test.properties)
        # Test exclusions configured in pom.xml surefire plugin
        # TODO: Fix pre-existing failing tests and remove exclusions from pom.xml
        run: mvn test -B

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: backend/ikp-labs-api/target/surefire-reports/
          retention-days: 7

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: backend/ikp-labs-api/target/site/jacoco/
          retention-days: 7

      - name: Coverage Summary
        working-directory: backend/ikp-labs-api
        run: |
          echo "## Backend Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f target/site/jacoco/index.html ]; then
            echo "‚úÖ JaCoCo coverage report generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìä Coverage report uploaded as artifact" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================
  # API Tests (Playwright + Spring Boot + PostgreSQL)
  # Tests real API endpoints against running backend
  # ===========================================
  api-tests:
    name: API Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: registrationform_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Backend Setup ---
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build backend (skip tests)
        working-directory: backend/ikp-labs-api
        run: mvn package -DskipTests -B

      - name: Start Spring Boot backend
        working-directory: backend/ikp-labs-api
        run: |
          nohup java -jar target/*.jar \
            --spring.datasource.url=jdbc:postgresql://localhost:5432/registrationform_db \
            --spring.datasource.username=postgres \
            --spring.datasource.password=postgres \
            --spring.jpa.hibernate.ddl-auto=update \
            > /tmp/spring-boot.log 2>&1 &

      - name: Wait for backend health check
        run: |
          echo "Waiting for backend to start..."
          for i in $(seq 1 30); do
            if curl -s http://localhost:8081/api/auth/health | grep -q "UP"; then
              echo "‚úÖ Backend is healthy!"
              exit 0
            fi
            echo "Attempt $i/30 - waiting 5s..."
            sleep 5
          done
          echo "‚ùå Backend failed to start within 150s"
          echo "=== Spring Boot Log (last 50 lines) ==="
          tail -50 /tmp/spring-boot.log || true
          exit 1

      # --- Playwright API Tests ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run API tests
        run: npx playwright test --project=api-tests

      - name: Upload API test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # ===========================================
  # E2E Tests - MOVED TO SCHEDULED WORKFLOW
  # E2E tests now run on a schedule (6 AM & 6 PM WIB) instead of on every PR
  # See: .github/workflows/scheduled-e2e.yml
  # Rationale: Faster PR workflow, cost-effective CI usage
  # ===========================================

  # ===========================================
  # Summary Job - All checks must pass
  # ===========================================
  ci-success:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [frontend-lint, frontend-tests, frontend-build, backend-tests, api-tests]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          # All jobs must pass
          if [[ "${{ needs.frontend-lint.result }}" != "success" ]] || \
             [[ "${{ needs.frontend-tests.result }}" != "success" ]] || \
             [[ "${{ needs.frontend-build.result }}" != "success" ]] || \
             [[ "${{ needs.backend-tests.result }}" != "success" ]] || \
             [[ "${{ needs.api-tests.result }}" != "success" ]]; then
            echo "‚ùå CI Failed!"
            echo "- Frontend Lint: ${{ needs.frontend-lint.result }}"
            echo "- Frontend Tests: ${{ needs.frontend-tests.result }}"
            echo "- Frontend Build: ${{ needs.frontend-build.result }}"
            echo "- Backend Tests: ${{ needs.backend-tests.result }}"
            echo "- API Tests: ${{ needs.api-tests.result }}"
            exit 1
          fi

          echo "‚úÖ All CI checks passed!"
          echo "- Frontend Lint: ${{ needs.frontend-lint.result }}"
          echo "- Frontend Tests: ${{ needs.frontend-tests.result }}"
          echo "- Frontend Build: ${{ needs.frontend-build.result }}"
          echo "- Backend Tests: ${{ needs.backend-tests.result }}"
          echo "- API Tests: ${{ needs.api-tests.result }}"
          echo ""
          echo "Note: E2E tests run on schedule (6 AM & 6 PM WIB)"
          echo "See: .github/workflows/scheduled-e2e.yml"
